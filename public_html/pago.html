<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - Biblioteca UTP</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/header.css">

    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle at top left, #dbeafe 0, #eff6ff 30%, #ffffff 60%, #e0f2fe 100%);
        }

        .pago-main {
            padding-top: 120px;
            padding-bottom: 40px;
        }

        .pago-container {
            max-width: 980px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.96);
            border-radius: 20px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
            padding: 26px 26px 22px;
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .pago-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
        }

        .pago-header h1 {
            font-size: 1.6rem;
            margin: 0;
            color: #0b1f4d;
        }

        .pago-header span {
            font-size: 0.95rem;
            color: #6b7280;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 6px 12px;
            background: #eff6ff;
            color: #1d4ed8;
            font-size: 0.85rem;
        }

        .pago-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
            gap: 20px;
        }

        .card-block {
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            padding: 16px 16px 12px;
            background: #ffffff;
        }

        .card-block h2 {
            font-size: 1.05rem;
            margin-bottom: 10px;
            color: #111827;
        }

        .resumen-items {
            max-height: 260px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .resumen-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #e5e7eb;
            font-size: 0.94rem;
        }

        .resumen-item:last-child {
            border-bottom: none;
        }

        .resumen-item span {
            display: block;
        }

        .resumen-item .nombre {
            font-weight: 500;
            color: #111827;
        }

        .resumen-item .detalle {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .resumen-totales {
            margin-top: 10px;
            border-top: 1px solid #e5e7eb;
            padding-top: 10px;
            font-size: 0.95rem;
        }

        .resumen-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .resumen-line.total {
            font-weight: 700;
            font-size: 1rem;
        }

        .form-label {
            font-size: 0.9rem;
            color: #374151;
        }

        .form-control, .form-select {
            font-size: 0.93rem;
        }

        .metodos-wrapper {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .metodo-pill {
            border-radius: 999px;
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            font-size: 0.88rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #374151;
            background: #f9fafb;
            transition: all 0.16s ease;
        }

        .metodo-pill input {
            display: none;
        }

        .metodo-pill.active {
            background: #1d4ed8;
            border-color: #1d4ed8;
            color: #f9fafb;
        }

        .metodo-pill i {
            font-size: 1rem;
        }

        .metodo-extra {
            margin-top: 8px;
        }

        .texto-ayuda {
            font-size: 0.82rem;
            color: #6b7280;
        }

        .pago-actions {
            margin-top: 14px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
        }

        .btn-pago {
            border-radius: 999px;
            padding-inline: 20px;
        }

        .mensaje-estado {
            font-size: 0.9rem;
        }

        .mensaje-estado.ok {
            color: #16a34a;
        }

        .mensaje-estado.error {
            color: #b91c1c;
        }

        @media (max-width: 900px) {
            .pago-container {
                margin-inline: 12px;
                padding: 18px 14px 16px;
            }

            .pago-grid {
                grid-template-columns: minmax(0, 1fr);
            }

            .pago-main {
                padding-top: 110px;
            }
        }
    </style>
</head>
<body>
    <header class="header"></header>

    <main class="pago-main">
        <div class="pago-container">
            <div class="pago-header">
                <div>
                    <h1>Confirmar pago</h1>
                    <span>Revisa tu pedido y completa tus datos para finalizar la compra.</span>
                </div>
                <span class="pill">
                    <i class="bi bi-shield-lock"></i> Pago simulado para trabajo académico
                </span>
            </div>

            <div class="pago-grid">
                <!-- Resumen del pedido -->
                <section class="card-block">
                    <h2>Resumen del pedido</h2>
                    <div class="resumen-items" id="resumen-items">
                        <p class="text-muted small mb-0">Cargando productos del carrito...</p>
                    </div>

                    <div class="resumen-totales" id="resumen-totales">
                        <div class="resumen-line">
                            <span>Subtotal</span>
                            <span id="subtotal-text">S/ 0.00</span>
                        </div>
                        <div class="resumen-line">
                            <span>Comisión plataforma</span>
                            <span>S/ 0.00</span>
                        </div>
                        <div class="resumen-line total">
                            <span>Total a pagar</span>
                            <span id="total-text">S/ 0.00</span>
                        </div>
                    </div>
                </section>

                <!-- Formulario de pago -->
                <section class="card-block">
                    <h2>Datos del estudiante</h2>
                    <div class="mb-2">
                        <label for="nombre" class="form-label">Nombre completo</label>
                        <input type="text" id="nombre" class="form-control" placeholder="Nombre y apellidos">
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <label for="codigo" class="form-label">Código UTP</label>
                            <input type="text" id="codigo" class="form-control" placeholder="Ej: 202312345">
                        </div>
                        <div class="col-md-6">
                            <label for="correo" class="form-label">Correo institucional</label>
                            <input type="email" id="correo" class="form-control" placeholder="nombre.apellido@utp.edu.pe">
                        </div>
                    </div>

                    <div class="mb-2">
                        <label for="campus" class="form-label">Campus de recojo</label>
                        <select id="campus" class="form-select">
                            <option value="">Selecciona un campus</option>
                            <option value="Lima">Campus Lima</option>
                            <option value="Arequipa">Campus Arequipa</option>
                            <option value="Chiclayo">Campus Chiclayo</option>
                            <option value="Trujillo">Campus Trujillo</option>
                        </select>
                    </div>

                    <hr class="my-3">

                    <h2>Método de pago</h2>
                    <div class="metodos-wrapper" id="metodos">
                        <label class="metodo-pill active">
                            <input type="radio" name="metodo" value="tarjeta" checked>
                            <i class="bi bi-credit-card-2-front"></i> Tarjeta
                        </label>

                        <label class="metodo-pill">
                            <input type="radio" name="metodo" value="yape">
                            <i class="bi bi-phone"></i> Yape
                        </label>

                        <label class="metodo-pill">
                            <input type="radio" name="metodo" value="plin">
                            <i class="bi bi-phone"></i> Plin
                        </label>
                    </div>

                    <div class="metodo-extra" id="extra-tarjeta">
                        <div class="mb-2">
                            <label for="numero-tarjeta" class="form-label">Número de tarjeta</label>
                            <input type="text" id="numero-tarjeta" class="form-control" placeholder="XXXX XXXX XXXX XXXX">
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label for="fecha-tarjeta" class="form-label">Fecha de vencimiento</label>
                                <input type="text" id="fecha-tarjeta" class="form-control" placeholder="MM/AA">
                            </div>
                            <div class="col-6">
                                <label for="cvv" class="form-label">CVV</label>
                                <input type="password" id="cvv" class="form-control" maxlength="4" placeholder="***">
                            </div>
                        </div>
                        <p class="texto-ayuda">
                            <i class="bi bi-info-circle"></i>
                            Esta información es solo simulada para el trabajo académico, no se realiza ningún cobro real.
                        </p>
                    </div>

                    <div class="metodo-extra d-none" id="extra-yape">
                        <div class="mb-2">
                            <label for="celular-yape" class="form-label">Número de celular asociado a Yape</label>
                            <input type="text" id="celular-yape" class="form-control" placeholder="9XXXXXXXX">
                        </div>
                        <p class="texto-ayuda">
                            Simulación de pago mediante Yape para fines del trabajo académico.
                        </p>
                    </div>

                    <div class="metodo-extra d-none" id="extra-plin">
                        <div class="mb-2">
                            <label for="celular-plin" class="form-label">Número de celular asociado a Plin</label>
                            <input type="text" id="celular-plin" class="form-control" placeholder="9XXXXXXXX">
                        </div>
                        <p class="texto-ayuda">
                            Simulación de pago mediante Plin para fines del trabajo académico.
                        </p>
                    </div>

                    <div class="pago-actions">
                        <a href="Carrito.html" class="btn btn-link text-secondary text-decoration-none">
                            <i class="bi bi-arrow-left"></i> Volver al carrito
                        </a>

                        <div class="text-end flex-grow-1">
                            <div id="mensaje-estado" class="mensaje-estado"></div>
                            <button type="button" id="btn-confirmar" class="btn btn-primary btn-pago mt-2">
                                <i class="bi bi-shield-check"></i> Confirmar pago
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script src="js/header.js"></script>
    <script src="js/load-header.js"></script>
    <script>
        // Cargar resumen desde el carrito (localStorage)
        function cargarResumen() {
            const contenedor = document.getElementById('resumen-items');
            const subtotalText = document.getElementById('subtotal-text');
            const totalText = document.getElementById('total-text');

            let carrito = [];
            try {
                carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            } catch (e) {
                console.warn('No se pudo leer el carrito en pago:', e);
            }

            if (!carrito.length) {
                contenedor.innerHTML = '<p class="text-muted small mb-0">Tu carrito está vacío. Vuelve al carrito para agregar productos.</p>';
                subtotalText.textContent = 'S/ 0.00';
                totalText.textContent = 'S/ 0.00';
                return;
            }

            contenedor.innerHTML = '';
            let subtotal = 0;

            carrito.forEach((p) => {
                const cantidad = p.cantidad || 1;
                const precio = parseFloat(p.precio) || 0;
                const totalItem = cantidad * precio;
                subtotal += totalItem;

                const item = document.createElement('div');
                item.className = 'resumen-item';
                item.innerHTML = `
                    <div>
                        <span class="nombre">${p.nombre || 'Producto'}</span>
                        <span class="detalle">Cantidad: ${cantidad} · Precio unidad: S/ ${precio.toFixed(2)}</span>
                    </div>
                    <span>S/ ${totalItem.toFixed(2)}</span>
                `;
                contenedor.appendChild(item);
            });

            subtotalText.textContent = 'S/ ' + subtotal.toFixed(2);
            totalText.textContent = 'S/ ' + subtotal.toFixed(2);
        }

        // Manejo de métodos de pago
        function configurarMetodosPago() {
            const contenedor = document.getElementById('metodos');
            const pills = contenedor.querySelectorAll('.metodo-pill');

            const secciones = {
                tarjeta: document.getElementById('extra-tarjeta'),
                yape: document.getElementById('extra-yape'),
                plin: document.getElementById('extra-plin')
            };

            function mostrarSeccion(metodo) {
                Object.keys(secciones).forEach((key) => {
                    if (key === metodo) {
                        secciones[key].classList.remove('d-none');
                    } else {
                        secciones[key].classList.add('d-none');
                    }
                });
            }

            pills.forEach((pill) => {
                pill.addEventListener('click', () => {
                    pills.forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');

                    const input = pill.querySelector('input[type="radio"]');
                    input.checked = true;
                    mostrarSeccion(input.value);
                });
            });

            mostrarSeccion('tarjeta');
        }

        // Validar y simular pago
        function configurarConfirmacion() {
            const btn = document.getElementById('btn-confirmar');
            const mensajeEstado = document.getElementById('mensaje-estado');

            btn.addEventListener('click', () => {
                const nombre = document.getElementById('nombre').value.trim();
                const codigo = document.getElementById('codigo').value.trim();
                const correo = document.getElementById('correo').value.trim();
                const campus = document.getElementById('campus').value;
                const metodo = document.querySelector('input[name="metodo"]:checked')?.value || 'tarjeta';

                if (!nombre || !codigo || !correo || !campus) {
                    mensajeEstado.textContent = 'Completa todos los datos obligatorios para continuar.';
                    mensajeEstado.className = 'mensaje-estado error';
                    return;
                }

                // Validaciones simples
                if (!/^[0-9]{9}$/.test(codigo)) {
                    mensajeEstado.textContent = 'Ingresa un código UTP válido (9 dígitos).';
                    mensajeEstado.className = 'mensaje-estado error';
                    return;
                }

                if (!correo.endsWith('@utp.edu.pe')) {
                    mensajeEstado.textContent = 'Usa tu correo institucional (@utp.edu.pe).';
                    mensajeEstado.className = 'mensaje-estado error';
                    return;
                }

                if (metodo === 'tarjeta') {
                    const num = document.getElementById('numero-tarjeta').value.replace(/\s+/g, '');
                    const fecha = document.getElementById('fecha-tarjeta').value.trim();
                    const cvv = document.getElementById('cvv').value.trim();

                    if (num.length < 13 || num.length > 19) {
                        mensajeEstado.textContent = 'Ingresa un número de tarjeta simulado válido.';
                        mensajeEstado.className = 'mensaje-estado error';
                        return;
                    }
                    if (!fecha) {
                        mensajeEstado.textContent = 'Ingresa la fecha de vencimiento (formato MM/AA).';
                        mensajeEstado.className = 'mensaje-estado error';
                        return;
                    }
                    if (cvv.length < 3) {
                        mensajeEstado.textContent = 'Ingresa un CVV simulado válido (3 o 4 dígitos).';
                        mensajeEstado.className = 'mensaje-estado error';
                        return;
                    }
                } else if (metodo === 'yape') {
                    const cel = document.getElementById('celular-yape').value.trim();
                    if (!/^9[0-9]{8}$/.test(cel)) {
                        mensajeEstado.textContent = 'Ingresa un número de celular válido para Yape.';
                        mensajeEstado.className = 'mensaje-estado error';
                        return;
                    }
                } else if (metodo === 'plin') {
                    const cel = document.getElementById('celular-plin').value.trim();
                    if (!/^9[0-9]{8}$/.test(cel)) {
                        mensajeEstado.textContent = 'Ingresa un número de celular válido para Plin.';
                        mensajeEstado.className = 'mensaje-estado error';
                        return;
                    }
                }

                // Simulación de confirmación de pago
                mensajeEstado.textContent = 'Pago registrado correctamente. Tu pedido ha sido confirmado. ✔';
                mensajeEstado.className = 'mensaje-estado ok';

                // Vaciar carrito (simulación de cierre de pedido)
                try {
                    localStorage.removeItem('carrito');
                } catch (e) {
                    console.warn('No se pudo limpiar el carrito:', e);
                }

                setTimeout(() => {
                    window.location.href = 'Productos.html';
                }, 2500);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            cargarResumen();
            configurarMetodosPago();
            configurarConfirmacion();
        });
    </script>
</body>
</html>
